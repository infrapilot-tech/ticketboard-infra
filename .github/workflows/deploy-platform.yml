name: Deploy to Kubernetes

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-frontend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl config use-context kind-kind

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Hub secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            -n ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Database and Services (immutable resources)
        run: |
          echo "ğŸ—„ï¸ Deploying database and services..."
          kubectl apply -f k8s/database/ -n ticketboard
          kubectl apply -f k8s/backend/configmap.yaml -n ticketboard
          kubectl apply -f k8s/backend/secrets.yaml -n ticketboard
          kubectl apply -f k8s/backend/service.yaml -n ticketboard
          kubectl apply -f k8s/frontend/service.yaml -n ticketboard

      - name: Delete and recreate backend deployment
        run: |
          echo "ğŸ”§ Recreating backend deployment..."
          # Eliminar deployment existente si existe
          kubectl delete deployment backend -n ticketboard --ignore-not-found=true

          # Crear nuevo deployment con la imagen correcta
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: ticketboard
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                imagePullSecrets:
                - name: dockerhub-secret
                containers:
                - name: backend
                  image: ${{ env.BACKEND_IMAGE }}:latest
                  ports:
                  - containerPort: 80
                  env:
                  - name: DB_HOST
                    value: "postgres-service"
                  - name: DB_PORT
                    value: "5432"
                  - name: DB_NAME
                    valueFrom:
                      configMapKeyRef:
                        name: backend-config
                        key: DB_NAME
                  - name: DB_USERNAME
                    valueFrom:
                      secretKeyRef:
                        name: backend-secrets
                        key: DB_USERNAME
                  - name: DB_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: backend-secrets
                        key: DB_PASSWORD
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 20
                    periodSeconds: 5
                    timeoutSeconds: 3
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 40
                    periodSeconds: 10
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
          EOF

      - name: Delete and recreate frontend deployment
        run: |
          echo "ğŸ¨ Recreating frontend deployment..."
          # Eliminar deployment existente si existe
          kubectl delete deployment frontend -n ticketboard --ignore-not-found=true

          # Crear nuevo deployment con la imagen correcta
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: ticketboard
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: frontend
            template:
              metadata:
                labels:
                  app: frontend
              spec:
                imagePullSecrets:
                - name: dockerhub-secret
                containers:
                - name: frontend
                  image: ${{ env.FRONTEND_IMAGE }}:latest
                  ports:
                  - containerPort: 80
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 20
                    periodSeconds: 10
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "50m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          EOF

      - name: Wait for database
        run: |
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=300s

      - name: Wait for services
        run: |
          echo "â³ Waiting for backend and frontend..."
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=backend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=frontend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed!"
          echo "ğŸ“Š Pods status:"
          kubectl get pods -n ticketboard
          echo "ğŸŒ Services:"
          kubectl get services -n ticketboard
