name: Deploy Complete Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  setup-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Setup Kubernetes Tools
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

      - name: Create Kind Cluster and Registry
        run: |
          # Crear registry primero
          docker run -d --restart=always -p 5000:5000 --name kind-registry registry:2

          # Crear cluster Kind
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          name: ticketboard-cluster
          containerdConfigPatches:
          - |-
            [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
              endpoint = ["http://kind-registry:5000"]
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30000
              hostPort: 30000
              protocol: TCP
            - containerPort: 30001
              hostPort: 30001
              protocol: TCP
          EOF

          # Conectar registry al cluster
          docker network connect kind kind-registry || true

          # CONFIGURACIÃ“N CRÃTICA: Exportar el kubeconfig
          kind export kubeconfig --name ticketboard-cluster

          # Verificar la conexiÃ³n
          echo "ðŸ” Verifying cluster connection..."
          kubectl cluster-info
          kubectl get nodes

  deploy-database:
    runs-on: ubuntu-latest
    needs: setup-cluster

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl Context
        run: |
          # Asegurar que el contexto estÃ¡ configurado
          kind export kubeconfig --name ticketboard-cluster
          kubectl config use-context kind-ticketboard-cluster
          kubectl cluster-info

      - name: Deploy Database
        run: |
          echo "ðŸ—„ï¸ Deploying database..."
          # Usar --validate=false para evitar errores de conexiÃ³n temporal
          kubectl apply -k k8s/base/ --validate=false
          kubectl apply -k k8s/database/ -n ticketboard --validate=false

          echo "â³ Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=180s
          echo "âœ… Database deployed"

  build-backend:
    runs-on: ubuntu-latest
    needs: deploy-database

    steps:
      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-backend
          path: backend

      - name: Configure Kubectl Context
        run: |
          kind export kubeconfig --name ticketboard-cluster

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          cd backend
          npm ci

      - name: Build and Push Backend Image
        run: |
          cd backend
          docker build -t localhost:5000/ticketboard-backend:latest .
          docker push localhost:5000/ticketboard-backend:latest
          echo "âœ… Backend image built and pushed"

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl Context
        run: |
          kind export kubeconfig --name ticketboard-cluster

      - name: Deploy Backend
        run: |
          kubectl apply -k k8s/backend/ -n ticketboard --validate=false
          kubectl wait --for=condition=ready pod -l app=backend -n ticketboard --timeout=180s
          echo "âœ… Backend deployed"

  build-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout Frontend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-frontend
          path: frontend

      - name: Configure Kubectl Context
        run: |
          kind export kubeconfig --name ticketboard-cluster

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies and Build
        run: |
          cd frontend
          npm ci
          VITE_API_URL=http://backend-service:8080 npm run build

      - name: Build and Push Frontend Image
        run: |
          cd frontend
          docker build -t localhost:5000/ticketboard-frontend:latest .
          docker push localhost:5000/ticketboard-frontend:latest
          echo "âœ… Frontend image built and pushed"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl Context
        run: |
          kind export kubeconfig --name ticketboard-cluster

      - name: Deploy Frontend
        run: |
          kubectl apply -k k8s/frontend/ -n ticketboard --validate=false
          kubectl wait --for=condition=ready pod -l app=frontend -n ticketboard --timeout=180s
          echo "âœ… Frontend deployed"

  final-verification:
    runs-on: ubuntu-latest
    needs: [ deploy-backend, deploy-frontend ]

    steps:
      - name: Configure Kubectl Context
        run: |
          kind export kubeconfig --name ticketboard-cluster

      - name: Verify Deployment
        run: |
          echo "ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          kubectl get all -n ticketboard
          echo ""
          echo "ðŸš€ Application URLs:"
          echo "   Frontend: http://localhost:30000"
          echo "   Backend:  http://localhost:30001"
