name: Deploy to Kubernetes

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-frontend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl config use-context kind-kind

      - name: Install kustomize
        run: |
          # Instalar kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Hub secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            -n ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Build and apply Kustomize
        run: |
          echo "ðŸ”¨ Building Kustomize manifests..."
          kustomize build k8s/overlays/development | kubectl apply -f -

      - name: Update images to latest
        run: |
          kubectl set image deployment/backend -n ticketboard backend=${{ env.BACKEND_IMAGE }}:latest
          kubectl set image deployment/frontend -n ticketboard frontend=${{ env.FRONTEND_IMAGE }}:latest

      - name: Wait for database
        run: |
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=300s

      - name: Wait for services
        run: |
          echo "â³ Waiting for backend and frontend..."
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=backend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=frontend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed!"
          kubectl get all -n ticketboard
