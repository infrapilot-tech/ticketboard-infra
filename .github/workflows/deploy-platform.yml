name: Deploy Complete Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Setup Kubernetes Tools
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

      - name: Cleanup Existing Clusters
        run: |
          echo "ğŸ§¹ Checking for existing clusters..."
          # Listar y eliminar todos los clusters existentes
          kind get clusters || echo "No existing clusters found"
          for cluster in $(kind get clusters 2>/dev/null || true); do
            echo "Deleting cluster: $cluster"
            kind delete cluster --name "$cluster"
          done

      - name: Create Registry
        run: |
          echo "ğŸ³ Setting up registry..."
          # Eliminar registry existente si existe
          docker stop registry 2>/dev/null || true
          docker rm registry 2>/dev/null || true
          # Crear nuevo registry
          docker run -d --restart=always -p 5000:5000 --name registry registry:2

      - name: Create Kind Cluster
        run: |
          echo "ğŸš€ Creating Kind cluster..."
          # Crear cluster sin nombre especÃ­fico (usa el default)
          kind create cluster --wait 5m

          echo "ğŸ”— Connecting registry to cluster..."
          docker network connect kind registry || true

          echo "ğŸ” Verifying cluster creation..."
          # Verificar que el cluster se creÃ³
          kind get clusters
          kubectl cluster-info
          kubectl get nodes

      - name: Configure Kubectl Properly
        run: |
          echo "âš™ï¸ Configuring kubectl context..."
          # Obtener el nombre REAL del cluster
          CLUSTER_NAME=$(kind get clusters | head -1)
          echo "Using cluster: $CLUSTER_NAME"

          # Exportar kubeconfig para el cluster real
          kind export kubeconfig --name "$CLUSTER_NAME"

          # Verificar la configuraciÃ³n
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy Base Infrastructure
        run: |
          echo "ğŸ—ï¸ Deploying base infrastructure..."
          kubectl apply -k k8s/base/ --validate=false
          echo "âœ… Base deployed"

      - name: Deploy Database
        run: |
          echo "ğŸ—„ï¸ Deploying database..."
          kubectl apply -k k8s/database/ -n ticketboard --validate=false
          echo "â³ Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=180s
          echo "âœ… Database deployed"

      - name: Deploy Backend
        run: |
          echo "ğŸ”§ Deploying backend..."
          kubectl apply -k k8s/backend/ -n ticketboard --validate=false
          echo "âœ… Backend deployed"

      - name: Deploy Frontend
        run: |
          echo "ğŸ¨ Deploying frontend..."
          kubectl apply -k k8s/frontend/ -n ticketboard --validate=false
          echo "âœ… Frontend deployed"

      - name: Wait for All Services
        run: |
          echo "â³ Waiting for all services to be ready..."
          kubectl wait --for=condition=ready --timeout=300s -n ticketboard --all pod

          echo "ğŸ‰ TICKETBOARD DEPLOYED SUCCESSFULLY!"
          echo ""
          echo "ğŸ“Š Final Status:"
          kubectl get all -n ticketboard
          echo ""
          echo "ğŸŒ Access URLs:"
          echo "   Frontend: http://localhost:30000"
          echo "   Backend:  http://localhost:30001"
