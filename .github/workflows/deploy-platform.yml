name: Deploy to Kubernetes

on:
  workflow_dispatch: # Solo ejecución manual
  push:
    branches: [ main ] # También en push a main si quieres

env:
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-frontend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl config use-context ${{ vars.CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ vars.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Kustomize
        run: |
          kubectl apply -k k8s/overlays/development

      - name: Update to latest images
        run: |
          kubectl set image deployment/backend -n ${{ vars.NAMESPACE }} backend=${{ env.BACKEND_IMAGE }}:latest
          kubectl set image deployment/frontend -n ${{ vars.NAMESPACE }} frontend=${{ env.FRONTEND_IMAGE }}:latest

      - name: Wait for database
        run: |
          echo "⏳ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ vars.NAMESPACE }} --timeout=300s

      - name: Wait for all services
        run: |
          echo "⏳ Waiting for all services to be ready..."
          timeout 300s bash -c 'until kubectl get pods -n ${{ vars.NAMESPACE }} -l app=backend --no-headers | grep -q "Running"; do sleep 5; done'
          timeout 300s bash -c 'until kubectl get pods -n ${{ vars.NAMESPACE }} -l app=frontend --no-headers | grep -q "Running"; do sleep 5; done'

      - name: Verify deployment
        run: |
          echo "✅ Deployment completed!"
          kubectl get all -n ${{ vars.NAMESPACE }}
