name: Deploy to Kubernetes

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ticketboard-frontend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl config use-context kind-kind

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Hub secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            -n ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Monitoring Stack
        run: |
          echo "ğŸ“Š Deploying monitoring stack..."
          # Crear ConfigMap de Prometheus
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: ticketboard
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
              
              scrape_configs:
                - job_name: 'prometheus'
                  static_configs:
                    - targets: ['localhost:9090']

                - job_name: 'ticketboard-backend'
                  static_configs:
                    - targets: ['backend-service:3000']
                  metrics_path: '/metrics'
                  scrape_interval: 10s

                - job_name: 'ticketboard-frontend'
                  static_configs:
                    - targets: ['frontend-service:80']
                  metrics_path: '/metrics'
                  scrape_interval: 10s
            alert-rules.yml: |
              groups:
              - name: ticketboard.rules
                rules:
                - alert: BackendDown
                  expr: up{job="ticketboard-backend"} == 0
                  for: 1m
                  labels:
                    severity: critical
                  annotations:
                    summary: "Backend service is down"
                    description: "The ticketboard backend has been down for more than 1 minute."
          EOF

          # Desplegar Prometheus
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: ticketboard
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                - name: prometheus
                  image: prom/prometheus:latest
                  ports:
                  - containerPort: 9090
                  volumeMounts:
                  - name: prometheus-config
                    mountPath: /etc/prometheus
                  - name: prometheus-storage
                    mountPath: /prometheus
                  args:
                  - '--config.file=/etc/prometheus/prometheus.yml'
                  - '--storage.tsdb.path=/prometheus'
                  - '--storage.tsdb.retention.time=200h'
                  - '--web.enable-lifecycle'
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "100m"
                    limits:
                      memory: "1Gi"
                      cpu: "500m"
                volumes:
                - name: prometheus-config
                  configMap:
                    name: prometheus-config
                - name: prometheus-storage
                  emptyDir: {}
          EOF

          # Servicio de Prometheus
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus-service
            namespace: ticketboard
          spec:
            selector:
              app: prometheus
            ports:
            - port: 9090
              targetPort: 9090
            type: ClusterIP
          EOF

          # Desplegar Grafana
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: ticketboard
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                - name: grafana
                  image: grafana/grafana:latest
                  ports:
                  - containerPort: 3050
                  env:
                  - name: GF_SECURITY_ADMIN_USER
                    value: "admin"
                  - name: GF_SECURITY_ADMIN_PASSWORD
                    value: "grafana"
                  volumeMounts:
                  - name: grafana-storage
                    mountPath: /var/lib/grafana
                  - name: grafana-datasources
                    mountPath: /etc/grafana/provisioning/datasources
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "300m"
                volumes:
                - name: grafana-storage
                  emptyDir: {}
                - name: grafana-datasources
                  configMap:
                    name: grafana-datasources
          EOF

          # ConfigMap para datasources de Grafana
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-datasources
            namespace: ticketboard
          data:
            datasources.yaml: |
              apiVersion: 1
              datasources:
              - name: Prometheus
                type: prometheus
                access: proxy
                url: http://prometheus-service:9090
                isDefault: true
          EOF

          # Servicio de Grafana
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana-service
            namespace: ticketboard
          spec:
            selector:
              app: grafana
            ports:
            - port: 3050
              targetPort: 3050
            type: ClusterIP
          EOF

      - name: Deploy Database
        run: |
          echo "ğŸ—„ï¸ Deploying database..."
          kubectl apply -f k8s/database/postgresql.yaml -n ticketboard
          kubectl apply -f k8s/database/pvc.yaml -n ticketboard

      - name: Deploy Backend Config and Service
        run: |
          echo "ğŸ”§ Deploying backend configuration..."
          kubectl apply -f k8s/backend/configmap.yaml -n ticketboard
          kubectl apply -f k8s/backend/secrets.yaml -n ticketboard
          kubectl apply -f k8s/backend/service.yaml -n ticketboard

      - name: Deploy Frontend Service
        run: |
          echo "ğŸ¨ Deploying frontend service..."
          kubectl apply -f k8s/frontend/service.yaml -n ticketboard

      - name: Delete and recreate backend deployment
        run: |
          echo "ğŸ”§ Recreating backend deployment..."
          kubectl delete deployment backend -n ticketboard --ignore-not-found=true

          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: ticketboard
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "3000"
                  prometheus.io/path: "/metrics"
              spec:
                imagePullSecrets:
                - name: dockerhub-secret
                containers:
                - name: backend
                  image: ${{ env.BACKEND_IMAGE }}:latest
                  ports:
                  - containerPort: 3000
                  env:
                  - name: PORT
                    value: "3000"
                  - name: DB_HOST
                    value: "postgres-service"
                  - name: DB_PORT
                    value: "5432"
                  - name: DB_NAME
                    valueFrom:
                      configMapKeyRef:
                        name: backend-config
                        key: DB_NAME
                  - name: DB_USERNAME
                    valueFrom:
                      secretKeyRef:
                        name: backend-secrets
                        key: DB_USERNAME
                  - name: DB_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: backend-secrets
                        key: DB_PASSWORD
                  readinessProbe:
                    httpGet:
                      path: /healthz
                      port: 3000
                    initialDelaySeconds: 15
                    periodSeconds: 10
                    timeoutSeconds: 5
                  livenessProbe:
                    httpGet:
                      path: /healthz
                      port: 3000
                    initialDelaySeconds: 30
                    periodSeconds: 15
                    timeoutSeconds: 5
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "50m"
                    limits:
                      memory: "128Mi"
                      cpu: "100m"
          EOF

      - name: Update backend service
        run: |
          echo "ğŸ”§ Updating backend service..."
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: backend-service
            namespace: ticketboard
          spec:
            selector:
              app: backend
            ports:
              - port: 80
                targetPort: 3000
            type: ClusterIP
          EOF

      - name: Delete and recreate frontend deployment
        run: |
          echo "ğŸ¨ Recreating frontend deployment..."
          kubectl delete deployment frontend -n ticketboard --ignore-not-found=true

          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: ticketboard
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: frontend
            template:
              metadata:
                labels:
                  app: frontend
              spec:
                imagePullSecrets:
                - name: dockerhub-secret
                containers:
                - name: frontend
                  image: ${{ env.FRONTEND_IMAGE }}:latest
                  ports:
                  - containerPort: 80
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 20
                    periodSeconds: 10
                  resources:
                    requests:
                      memory: "32Mi"
                      cpu: "25m"
                    limits:
                      memory: "64Mi"
                      cpu: "50m"
          EOF

      - name: Wait for monitoring stack
        run: |
          echo "â³ Waiting for monitoring stack..."
          kubectl wait --for=condition=ready pod -l app=prometheus -n ticketboard --timeout=180s
          kubectl wait --for=condition=ready pod -l app=grafana -n ticketboard --timeout=180s

      - name: Wait for database
        run: |
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=300s

      - name: Wait for services
        run: |
          echo "â³ Waiting for backend and frontend..."
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=backend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=frontend --no-headers 2>/dev/null | grep -q "Running"; do sleep 5; done'

      - name: Verify deployment and monitoring
        run: |
          echo "âœ… Deployment completed!"
          echo "ğŸ“Š Pods status:"
          kubectl get pods -n ticketboard
          echo "ğŸŒ Services:"
          kubectl get services -n ticketboard

          echo "ğŸ” Testing connectivity..."
          kubectl exec -n ticketboard -it $(kubectl get pod -n ticketboard -l app=backend -o name | head -1) -- curl -f http://localhost:3000/healthz && echo "âœ… Backend health check passed"

          echo "ğŸ“ˆ Testing metrics endpoint..."
          kubectl exec -n ticketboard -it $(kubectl get pod -n ticketboard -l app=backend -o name | head -1) -- curl -f http://localhost:3000/metrics && echo "âœ… Backend metrics available"

          echo "ğŸ¯ Testing Prometheus targets..."
          kubectl exec -n ticketboard -it $(kubectl get pod -n ticketboard -l app=prometheus -o name) -- wget -q -O - http://localhost:9090/api/v1/targets | grep -q "ticketboard-backend" && echo "âœ… Prometheus scraping backend"

          echo "ğŸ“Š Monitoring stack status:"
          echo "Prometheus: http://localhost:9090 (port-forward: kubectl port-forward -n ticketboard service/prometheus-service 9090:9090)"
          echo "Grafana: http://localhost:3050 (port-forward: kubectl port-forward -n ticketboard service/grafana-service 3050:3050)"
          echo "Grafana credentials: admin/grafana"

      - name: Create Ingress for monitoring (optional)
        run: |
          echo "ğŸŒ Creating ingress for monitoring services..."
          kubectl apply -f - <<EOF
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: monitoring-ingress
            namespace: ticketboard
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            rules:
            - host: localhost
              http:
                paths:
                - path: /prometheus
                  pathType: Prefix
                  backend:
                    service:
                      name: prometheus-service
                      port:
                        number: 9090
                - path: /grafana
                  pathType: Prefix
                  backend:
                    service:
                      name: grafana-service
                      port:
                        number: 3050
          EOF
